From 8cb4105e3f009bcd701c600d0b4a98c65b859f80 Mon Sep 17 00:00:00 2001
From: Jean-Philippe Brucker <jean-philippe@linaro.org>
Date: Wed, 2 Mar 2022 17:11:57 +0000
Subject: [PATCH 73/97] KVM: arm64: pgtable: Add kvm_pgt_level_is_last()

Add kvm_pgt_level_is_last(). A cosmetic change.

Signed-off-by: Jean-Philippe Brucker <jean-philippe@linaro.org>
---
 arch/arm64/kvm/hyp/pgtable.c | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/arch/arm64/kvm/hyp/pgtable.c b/arch/arm64/kvm/hyp/pgtable.c
index 062b8e251dce..e98bb3725dbd 100644
--- a/arch/arm64/kvm/hyp/pgtable.c
+++ b/arch/arm64/kvm/hyp/pgtable.c
@@ -108,9 +108,14 @@ static u32 kvm_pgd_pages(u32 ia_bits, u32 start_level)
 	return __kvm_pgd_page_idx(&pgt, -1ULL) + 1;
 }
 
+static bool kvm_pgt_level_is_last(int level)
+{
+	return level == KVM_PGTABLE_MAX_LEVELS - 1;
+}
+
 static bool kvm_pte_table(kvm_pte_t pte, u32 level)
 {
-	if (level == KVM_PGTABLE_MAX_LEVELS - 1)
+	if (kvm_pgt_level_is_last(level))
 		return false;
 
 	if (!kvm_pte_valid(pte))
@@ -154,8 +159,8 @@ static void kvm_set_table_pte(kvm_pte_t *ptep, kvm_pte_t *childp,
 static kvm_pte_t kvm_init_valid_leaf_pte(u64 pa, kvm_pte_t attr, u32 level)
 {
 	kvm_pte_t pte = kvm_phys_to_pte(pa);
-	u64 type = (level == KVM_PGTABLE_MAX_LEVELS - 1) ? KVM_PTE_TYPE_PAGE :
-							   KVM_PTE_TYPE_BLOCK;
+	u64 type = kvm_pgt_level_is_last(level) ? KVM_PTE_TYPE_PAGE :
+						  KVM_PTE_TYPE_BLOCK;
 
 	pte |= attr & (KVM_PTE_LEAF_ATTR_LO | KVM_PTE_LEAF_ATTR_HI);
 	pte |= FIELD_PREP(KVM_PTE_TYPE, type);
@@ -407,7 +412,7 @@ static int hyp_map_walker(u64 addr, u64 end, u32 level, kvm_pte_t *ptep,
 	if (hyp_map_walker_try_leaf(addr, end, level, ptep, arg))
 		return 0;
 
-	if (WARN_ON(level == KVM_PGTABLE_MAX_LEVELS - 1))
+	if (WARN_ON(kvm_pgt_level_is_last(level)))
 		return -EINVAL;
 
 	childp = (kvm_pte_t *)mm_ops->zalloc_page(NULL);
@@ -802,7 +807,7 @@ static int stage2_map_walk_leaf(u64 addr, u64 end, u32 level, kvm_pte_t *ptep,
 	if (ret != -E2BIG)
 		return ret;
 
-	if (WARN_ON(level == KVM_PGTABLE_MAX_LEVELS - 1))
+	if (WARN_ON(kvm_pgt_level_is_last(level)))
 		return -EINVAL;
 
 	if (!data->memcache)
-- 
2.34.1

