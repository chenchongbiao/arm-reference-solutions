From 233be35e7e3aca12a780eca6e42525cf87de587e Mon Sep 17 00:00:00 2001
From: Jean-Philippe Brucker <jean-philippe@linaro.org>
Date: Mon, 21 Feb 2022 12:07:14 +0000
Subject: [PATCH 46/97] fixup! KVM: arm64: Call __pkvm_host_share_guest on
 memory abort

TODO: check this
---
 arch/arm64/kvm/mmu.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/arch/arm64/kvm/mmu.c b/arch/arm64/kvm/mmu.c
index 24d05284279e..dbbedc950948 100644
--- a/arch/arm64/kvm/mmu.c
+++ b/arch/arm64/kvm/mmu.c
@@ -1210,7 +1210,7 @@ static int pkvm_mem_abort(struct kvm_vcpu *vcpu, phys_addr_t fault_ipa,
 		goto dec_account;
 	}
 
-	spin_lock(&kvm->mmu_lock);
+	write_lock(&kvm->mmu_lock);
 	pfn = page_to_pfn(page);
 	ret = pkvm_host_donate_guest(pfn, fault_ipa >> PAGE_SHIFT);
 	if (ret) {
@@ -1222,12 +1222,12 @@ static int pkvm_mem_abort(struct kvm_vcpu *vcpu, phys_addr_t fault_ipa,
 	ppage->page = page;
 	INIT_LIST_HEAD(&ppage->link);
 	list_add(&ppage->link, &kvm->arch.pkvm.pinned_pages);
-	spin_unlock(&kvm->mmu_lock);
+	write_unlock(&kvm->mmu_lock);
 
 	return 0;
 
 unpin:
-	spin_unlock(&kvm->mmu_lock);
+	write_unlock(&kvm->mmu_lock);
 	unpin_user_pages(&page, 1);
 dec_account:
 	account_locked_vm(mm, 1, false);
-- 
2.34.1

